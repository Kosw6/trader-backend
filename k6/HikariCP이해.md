## HikariCP란

- HikariCP는 애플리케이션과 데이터베이스 사이의 연결 풀(pool) 역할
- HikariCP는 minimumIdle의 개수만큼 앱이 처음 실행될 때에 JDBC를 통해 DB와 handshake를 통해 커넥션을 확보해둠 -> idle은 DB와 연결된 대기중인 커넥션
- active는 앱에서 DB요청이 발생하여 실제 DB와 작업중인 커넥션

### 왜 커넥션 풀이 필요한가

- 풀 없이 JDBC에서 매번 DB작업을 위해 인증 및 연결작업을 통해 커넥션을 생성하게 되면 CPU부하가 발생함
- 풀을 통해 일정기간 커넥션을 유지하도록 하여 해당 커넥션으로 재사용을 기대함

### 주요 파라미터

| 항목                     | 권장/범위                                                        | 설명 & 팁                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ------------------------ | ---------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `maximumPoolSize`        | **min( DB 여유 커넥션 / 앱 인스턴스 수 , maxThreads의 60~80% )** | 풀 최대 커넥션 수. Tomcat 스레드가 모두 DB를 잡지 않도록 약간 낮게. 너무 많을 경우 쓰레드가 DB작업으로 몰릴 위험이 있음                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| `minimumIdle`            | 0 ~ `maximumPoolSize`의 20~50%                                   | 유휴 커넥션 미리 유지. 너무 많이 유지하면 DB 세션을 과도하게 점유하여 pg_stat_activity에 idle 프로세스가 쌓이고, JVM 내 Socket/Buffer 리소스도 낭비됨. 특히 minimumIdle = maximumPoolSize로 둘 경우 항상 풀 전체가 점유되어 DB max_connections을 조기 고갈시키며, 앱 재시작 시 대량 handshake로 DB CPU spike 유발 가능                                                                                                                                                                                                                                                                                              |
| `connectionTimeout`      | 2s ~ 5s                                                          | 풀에서 커넥션을 빌릴 때 최대 대기 시간. 너무 길 경우에는 대기 큐가 쌓여 병목 발생, 너무 짧을 경우에는 불필요한 실패가 빈번                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| `idleTimeout`            | 30s ~ 300s                                                       | 유휴 커넥션 회수. 연결된 반대 프로세스의 idle close보다 **짧게**. 너무 길면 반대편이 세션을 끊은 상태에서 연결시도를 하려다 오류 발생 가능성 높음                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `maxLifetime`            | 30m ~ 55m                                                        | 커넥션 재생성 주기. **DB/Proxy의 서버단 idle/TTL보다 30~60초 짧게**. 30~55분 권장됨(규칙적 재순환을 통해서 메모리 누수가능성을 줄이고 상태 관리를 통해 꼬임을 방지).<br>ex)Postgresql은 MVCC(Multi-Version Concurrency Control)이기에 각 트랜잭션은 시작 시점의 버전을 기억<br>->long transaction문제 발생 가능<br>한 작업이 오래 걸리게 되며 같은 튜플을 다른 작업에서 수정을 할 경우 평소면 VACUUM작업으로 옛 버전을 지워야 하는데 이전 작업이 지속되어 옛 버전을 조회할 수 있다고 판단-> 튜플 삭제 불가능 및 VACCUM작업 지연-> 죽은 튜플이 쌓여 디스크 크기가 증가-> 읽어야 할 페이지 수가 증가-> 쿼리 성능 하락 |
| `keepaliveTime`          | 0 또는 1~5m                                                      | 주기적 ping으로 중간 장비가 연결 끊지 않게. `maxLifetime`보다 훨씬 짧게.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `leakDetectionThreshold` | 2s ~ 5s(선택)                                                    | 커넥션 반납 누수 탐지. 부하테스트 중 임시로 켜서 스택트레이스 확인.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `autoCommit`             | true(기본)                                                       | 트랜잭션 직접 제어 시 false.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| Metric/Health            | Micrometer, `/actuator/health`                                   | 풀 고갈 감지용: active/idle 비율, borrow time을 모니터링.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |

## 🔗 참고

- [공식 문서 링크 HikariCP github](https://github.com/brettwooldridge/HikariCP/blob/dev/README.md#artifacts)
